---
- hosts: all
  become: true
  gather_facts: true
    
  vars:
    manage_filesystem: "{{ lookup('env','MANAGE_FILESYSTEM') | default('true') }}"
    update_packages: "{{ lookup('env','UPDATE_PACKAGES') | default('true') }}"
    install_requirements: "{{ lookup('env','INSTALL_REQUIREMENTS') | default('true') }}"
    install_motd: "{{ lookup('env','INSTALL_MOTD') | default('true') }}"
    username: "{{ lookup('env','USERNAME') | default('sthings') }}"
    lvm_home_sizing: "{{ lookup('env','LVM_HOME_SIZING') | default('15%') }}"
    lvm_root_sizing: "{{ lookup('env','LVM_ROOT_SIZING') | default('35%') }}"
    lvm_var_sizing: "{{ lookup('env','LVM_VAR_SIZING') | default('50%') }}"
    send_to_msteams: true 
    vault_instances:
      - https://vault.tiab.labda.sva.de:8200
      - https://vault.labul.sva.de:8200
      - https://vault-vsphere.labul.sva.de:8200
      - https://vault-pve.labul.sva.de:8200
  roles:
    - role: manage-filesystem
      when: manage_filesystem|bool

    - role: install-requirements
      when: install_requirements|bool

  post_tasks:
    - name: Install vault ca certificate to local system from multiple instances
      ansible.builtin.include_role:
        name: install-configure-vault
        tasks_from: install-ca-auth
      vars:
        vault_url: "{{ vault_instance }}"
      loop: "{{ vault_instances }}"
      loop_control:
        loop_var: vault_instance
      when: vault_instances is defined
      
