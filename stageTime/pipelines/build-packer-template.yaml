---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: build-packer-template
spec:
  workspaces:
    - name: shared-workspace
    - name: sshCredentials
  params:
    - name: bootConfigPath
      type: string
      default: ""
      description: path to kickstart file
    - name: defaultEnvironmentPath
      type: string
      default: ""
      description: path to default environment
    - name: gitRepoUrl
      type: string
      default: ""
      description: source git repo
    - name: gitRevision
      type: string
      default: "main"
      description: revision of source git repo
    - name: gitWorkspaceSubdirectory
      type: string
      default: ""
      description: subdirectory on workspace
    - name: osTemplatePath
      type: string
      default: ""
      description: path to os template
    - name: osVersion
      type: string
      default: ""
      description: to be build os version
    - name: packerWorkingImage
      type: string
      default: "eu.gcr.io/stuttgart-things/sthings-packer:1.9.4-8.3.0-1"
      description: the image on which ansible will run
    - name: vaultSecretName
      type: string
      default: ""
      description: name of vault secret
  tasks:
    - name: execute-packer
      runAfter:
        - fetch-repository
      taskRef:
        resolver: git
        params:
          - name: url
            value: https://github.com/stuttgart-things/stuttgart-things.git
          - name: revision
            value: main
          - name: pathInRepo
            value: stageTime/tasks/build-packer.yaml
      workspaces:
        - name: source
          workspace: shared-workspace
      params:
        - name: BOOT_CONFIG_PATH
          value: $(params.bootConfigPath)
        - name: DEFAULT_ENVIRONMENT_PATH
          value: $(params.defaultEnvironmentPath)
        - name: OS_TEMPLATE_PATH
          value: $(params.osTemplatePath)
        - name: OS_VERSION
          value: $(params.osVersion)
        - name: SUB_DIRECTORY
          value: $(params.gitWorkspaceSubdirectory)
        - name: WORKING_IMAGE
          value: $(params.packerWorkingImage)
        - name: vaultSecretName
          value: $(params.vaultSecretName)
    - name: fetch-repository
      taskRef:
        resolver: git
        params:
          - name: url
            value: https://github.com/stuttgart-things/stuttgart-things.git
          - name: revision
            value: main
          - name: pathInRepo
            value: stageTime/tasks/clone-git.yaml
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: sshCredentials
      params:
        - name: deleteExisting
          value: 'true'
        - name: revision
          value: $(params.gitRevision)
        - name: subdirectory
          value: $(params.gitWorkspaceSubdirectory)
        - name: url
          value: $(params.gitRepoUrl)