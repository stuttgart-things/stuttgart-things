---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: bootstrap-flux-cluster
spec:
  # params:
  #   - name: kubeconfigVaultPath
  #     description: path to kubeconfig secret in vault
  #     type: string
  #   - name: githubTokenVaultPath
  #     description: path to github token secret in vault
  #     type: string
  tasks:
    - name: getting-secrets
      taskRef:
        resolver: git
        params:
          - name: url
            value: https://github.com/stuttgart-things/stuttgart-things.git
          - name: revision
            value: main
          - name: pathInRepo
            value: stageTime/tasks/get-secrets.yaml
      params:
        - name: SECRET_PATHS
          value:
            - "git/data/github:token"
            - "kubeconfigs/data/dev21:kubeconfig"
    - name: bootstrap-flux
      params:
        - name: KUBECONFIG
          value: $(tasks.getting-secrets.results.secrets[0])
        - name: GITHUB_TOKEN
          value: $(tasks.getting-secrets.results.secrets[1])
      taskRef:
        resolver: git
        params:
          - name: url
            value: https://github.com/stuttgart-things/stuttgart-things.git
          - name: revision
            value: main
          - name: pathInRepo
            value: stageTime/tasks/bootstrap-flux.yaml