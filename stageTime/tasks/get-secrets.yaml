---
kind: Task
apiVersion: tekton.dev/v1 # or tekton.dev/v1beta1
metadata:
  name: get-secrets
  annotations:
    description: |
      A simple task that writes array
spec:
  params:
    - name: SECRET_PATHS
      description: vault secret paths
      type: array
      default: []
    - name: vault-secret-key-addr
      description: vaul addr key in the secret
      type: string
      default: "VAULT_ADDR"
    - name: vault-secret-key-approleId
      description: approle id key in the secret
      type: string
      default: "VAULT_ROLE_ID"
    - name: vault-secret-key-approleSecret
      description: approle secret key in the secret
      type: string
      default: "VAULT_SECRET_ID"
    - name: vault-secret-key-namespace
      description: namespace key in the secret
      type: string
      default: "VAULT_NAMESPACE"
    - name: vaultSecretName
      description: name of the vault secret
      type: string
      default: vault-labul-vsphere
  results:
    - name: all-secrets
      type: array
      description: secret array results
  steps:
    - name: get-secrets
      image: eu.gcr.io/stuttgart-things/machineshop:0.1.46-1
      env:
        - name: VAULT_ADDR
          valueFrom:
            secretKeyRef:
              key: $(params.vault-secret-key-addr)
              name: $(params.vaultSecretName)
        - name: VAULT_NAMESPACE
          valueFrom:
            secretKeyRef:
              key: $(params.vault-secret-key-namespace)
              name: $(params.vaultSecretName)
        - name: VAULT_ROLE_ID
          valueFrom:
            secretKeyRef:
              key: $(params.vault-secret-key-approleId)
              name: $(params.vaultSecretName)
        - name: VAULT_SECRET_ID
          valueFrom:
            secretKeyRef:
              key: $(params.vault-secret-key-approleSecret)
              name: $(params.vaultSecretName)
      args:
        - $(params.SECRET_PATHS[*])
      script: |
        #!/usr/bin/env bash
        set -eu

        ALL_SECRETS=""
        for SECRET_PATH in "$@"
        do
          echo ${SECRET_PATH}
          SECRET=\"$(machineShop get --path ${SECRET_PATH} | sed '$!d')\"
          echo ${SECRET}
          ALL_SECRETS="${ALL_SECRETS}${ALL_SECRETS:+, }${SECRET}"
        done

        echo -n "[${ALL_SECRETS}]" | tee $(results.all-secrets.path)
