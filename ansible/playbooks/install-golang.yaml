---
- hosts: all
  become: true
  vars:
    golang_users:
      - username: otto
        name: otto user
        group: golang
        uid: 1011
        home: /home/otto
        profile: |
          alias ll='ls -ahl'
          export GOROOT=/usr/local/go
          export PATH=$GOROOT/bin:$PATH
          export GOPATH=/home/otto/usr/local/go
          export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
        generate_ssh_key: true
        #ssh_key:
        #  - "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
        enable_ssh_tcp_forwarding: true
        password: "!"
      - username: kevin
        name: kevin user
        group: golang
        uid: 1012
        home: /home/kevin
        profile: |
          alias ll='ls -ahl'
          export GOROOT=/usr/local/go
          export PATH=$GOROOT/bin:$PATH
          export GOPATH=/home/kevin/usr/local/go
          export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
        generate_ssh_key: true
        #ssh_key:
        #  - "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
        enable_ssh_tcp_forwarding: true
        password: "!"

    groups_golang:
      - name: golang
        gid: 31000

    golang_version: 1.22.2
    source_url: "https://go.dev/dl/go1.22.2.linux-amd64.tar.gz"
    download_dir: /tmp/downloads
    golang_install_dir: /usr/local/

  tasks:
    # MAYBE WE ADD A (PRIOR) CHECK FOR THE SHA OF THE EXTRACTED FOLDER - IF SAME VERSION SHOULD BE INSTALLED AGAIN
    # https://github.com/krahul084/python_scripts/blob/master/get_checksum.py
    #- get_checksum: 
    #    path: path/to/directory
    #    checksum_type: sha1/md5/sha256/sha512
    #  register: checksum

    # DELETE ALREADY INSTALLED GOLANG
    # -> CHECK FILE MODULE FOR REMOVING A DIR
    - name: Delete Golang
      shell:  "rm -rf /usr/local/go"
    # MAYBE LATER WE'RE COMAPRING TO A CHECKSUM IF NEEDS TO DELETE
    
    # DOWNLOAD AND INSTALL GOLANG
    - name: Unarchive and install Golang 
      ansible.builtin.unarchive:
        src: "{{ source_url }}"
        dest: "{{ golang_install_dir }}"
        mode: 0755
        validate_certs: false
        remote_src: true
    # MAYBE LATER WE'RE COMAPRING TO A CHECKSUM IF NEEDS TO BE DOWNLOADED AND INSTALLED AGAIN

    # CREATE USERS
    - name: Create golang users
      ansible.builtin.include_role:
        name: create-os-user
      vars:
        users: "{{ golang_users }}"
        groups_to_create: "{{ groups_golang }}"
      # SHOULD ONLY RUN IF golang_users ARE DEFINED
      
    # WRITE EXPORTS TO BASHRC
    # THIS SHOULD ONLY RUN IF NO USERS = DICT ARE DEFINED
    # THE VARIABLE go_username & go_usergroup (and optional go_userhome) SHOULD BE DEFINED
    - name: Add golang exports to bashrc
      ansible.builtin.blockinfile:
        block: |
          export GOROOT=/usr/local/go
          export PATH=$GOROOT/bin:$PATH
          export GOPATH=$HOME/usr/local/go
          export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
        dest: "{{ item.home | default('/home/' + item.username) }}/.bashrc"
        owner: "{{ item.username }}"
        group: "{{ item.group }}"
        mode: 0644
        create: true
      #loop: "{{ golang_users }}"
      # CHANGE VARIABLES INSIDE THIS TASK go_username -> NO ITEM.XY ...
