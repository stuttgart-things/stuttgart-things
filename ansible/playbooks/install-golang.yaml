---
- hosts: "{{ target_host | default('all') }}"
  become: true
  vars:
    golang_users:
      - username: otto
        name: otto user
        group: golang
        uid: 1011
        home: /home/otto
        profile: |
          alias ll='ls -ahl'
          export GOROOT=/usr/local/go
          export PATH=$GOROOT/bin:$PATH
          export GOPATH=/home/otto/usr/local/go
          export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
        generate_ssh_key: true
        #ssh_key:
        #  - "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
        enable_ssh_tcp_forwarding: true
        password: "!"

    groups_golang:
      - name: golang
        gid: 31000

    golang_version: 1.22.2
    source_url: "https://go.dev/dl/go1.22.2.linux-amd64.tar.gz"
    download_dir: /tmp/downloads
    golang_install_dir: /usr/local/
    go_username: otto
    go_usergroup: golang
    go_userhome: "/home/otto/"

    # Replace with checksum of new Golang version
    go_checksum: "x5901c52b7a78002aeff14a21f93e0f064f74ce1360fce51c6ee68cd471216a17"
    go_checksum_type: "sha256"

  pre_tasks:
    - name: Check if Golang already exists
      ansible.builtin.stat:
        path: "{{ golang_install_dir }}/go"
      register: check_golang

    - get_checksum:
        path: "{{ golang_install_dir }}go"
        checksum_type: "{{ go_checksum_type }}"
      register: checksum_old
      when: check_golang.stat.exists

  tasks:
    # MAYBE WE ADD A (PRIOR) CHECK FOR THE SHA OF THE EXTRACTED FOLDER - IF SAME VERSION SHOULD BE INSTALLED AGAIN
    # https://github.com/krahul084/python_scripts/blob/master/get_checksum.py
    #- get_checksum: 
    #    path: path/to/directory
    #    checksum_type: "{{ go_checksum_type }}"
    #  register: checksum
    #- get_checksum:
    #    path: "{{ download_dir }}/{{ source_url | regex_replace('^https://go.dev/dl/', '') }}"
    #    checksum_type: "{{ go_checksum_type }}"
    #  register: checksum
    #  ignore_errors: true

    - name: Create temporary download directory (if it does not exist)
      ansible.builtin.file:
        path: "{{ download_dir }}"
        state: directory
        mode: '1777'

    - name: Download Golang
      ansible.builtin.get_url:
        url: "{{ source_url }}"
        dest: "{{ download_dir }}/"

    - name: Unarchive Golang 
      ansible.builtin.unarchive:
        src: "{{ download_dir }}/{{ source_url | regex_replace('^https://go.dev/dl/', '') }}"
        dest: "{{ download_dir }}/"
        mode: 0755
        validate_certs: false
        remote_src: true

    - get_checksum:
        path: "{{ download_dir }}/go"
        checksum_type: "{{ go_checksum_type }}"
      register: checksum_new

    - name: Remove Golang if version is not equal
      ansible.builtin.file:
        path: "{{ golang_install_dir }}go"
        state: absent
      when: checksum_new.checksum_value != checksum_old.checksum_value | default(None)

    - name: Copy Golang folder
      ansible.builtin.copy:
        src: "{{ download_dir }}/go"
        dest: "{{ golang_install_dir }}"
        mode: 0755
        remote_src: true
      become: true
      when: checksum_new.checksum_value != checksum_old.checksum_value | default(None)

    - name: Delete downloading dir
      ansible.builtin.file:
        path: "{{ download_dir }}/"
        state: absent

#    - name: Skip when tar.gz not available
#      block:
#        # DELETE ALREADY INSTALLED GOLANG
#        - name: Remove Golang if version is not equal
#          ansible.builtin.file:
#            path: "{{ golang_install_dir }}go"
#            state: absent
#          when: checksum.stat.checksum != go_checksum
#
#        # Unarchive AND INSTALL GOLANG
#        - name: Unarchive and install Golang 
#          ansible.builtin.unarchive:
#            src: "{{ download_dir }}/{{ source_url | regex_replace('^https://go.dev/dl/', '') }}"
#            dest: "{{ golang_install_dir }}"
#            mode: 0755
#            validate_certs: false
#            remote_src: true
#          when: checksum.stat.checksum != go_checksum
#      when: checksum.stat.exists
#
    # CREATE USERS
    - name: Create golang users
      ansible.builtin.include_role:
        name: create-os-user
      vars:
        users: "{{ golang_users }}"
        groups_to_create: "{{ groups_golang }}"
      when: golang_users is defined

    # WRITE EXPORTS TO BASHRC
    # Initialize go_* variables with an already created user (no dict)
    - name: Add golang exports to bashrc
      ansible.builtin.blockinfile:
        block: |
          export GOROOT=/usr/local/go
          export PATH=$GOROOT/bin:$PATH
          export GOPATH=$HOME/usr/local/go
          export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
        dest: "{{ go_userhome }}.bashrc"
        owner: "{{ go_username }}"
        group: "{{ go_usergroup }}"
        mode: 0644
        create: true
      when: go_username is defined and go_usergroup is defined
