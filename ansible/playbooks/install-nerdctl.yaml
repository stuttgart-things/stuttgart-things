---
# TASK1:
#https://github.com/containerd/nerdctl/issues/341
# ADD CODE AS ANSIBLE TASKS
# mkdir -p $HOME/bin
#chmod 700 $HOME/bin
#cp /usr/local/bin/nerdctl $HOME/bin
#sudo chown root $HOME/bin/nerdctl
#sudo chmod +s $HOME/bin/nerdctl
#export PATH=$HOME/bin:$PATH

# TASK2:
# ADD TARGET VERSION
- hosts: "{{ target_host | default('all') }}"
  become: true
  vars:
    bin:
      nerdctl:
        bin_name: "nerdctl"
        bin_version: "1.7.6"
        check_bin_version_before_installing: true
        source_url: "https://github.com/containerd/nerdctl/releases/download/v1.7.6/nerdctl-full-1.7.6-linux-amd64.tar.gz"
        bin_to_copy: "."
        bin_dir: "/usr/local"
        to_remove: "*"
        version_cmd: " version"
        target_version: v1.7.6

    systemd_services:
      - containerd
      - buildkit

  roles:
    - download-install-binary

  post_tasks:
    - name: Enable systemd services
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        enabled: true
        daemon_reload: true
        state: started
      with_items:
        - "{{ systemd_services }}"
