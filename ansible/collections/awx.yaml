---
name: awx
version: 0.0.31
namespace: sthings
requirements: |
  roles:
    - src: https://github.com/stuttgart-things/download-install-binary.git
      scm: git
      version: 2024.05.24

playbooks:
  # ADD PLAYBOOK FOR DEPLOYING AWX CLI
  - name: base
    play: |
      ---
      - hosts: localhost
        vars:
          controller_host: "{{ lookup('env', 'CONTROLLER_HOST') }}"
          controller_username: "{{ lookup('env', 'CONTROLLER_USERNAME') }}"
          controller_password: "{{ lookup('env', 'CONTROLLER_PASSWORD') }}"

        vars_files:
          - "{{ path | default('.') }}/{{ profile | default('base') }}.yaml"

        tasks:
          - name: Create organizations
            awx.awx.organization:
              name: "{{ item.value.name }}"
              description: "{{ item.value.description }}"
              state: "{{ item.value.state }}"
              galaxy_credentials:
                - Ansible Galaxy
              validate_certs: no
            loop: "{{ lookup('dict', organizations, wantlist=True) }}"
            when: organizations is defined

          - name: Add machine credential
            awx.awx.credential:
              name: "{{ item.value.name }}"
              description: "{{ item.value.description }}"
              organization: "{{ item.value.organization }}"
              credential_type: Machine
              state: "{{ item.value.state }}"
              inputs:
                username: "{{ item.value.user }}"
                ssh_key_data: "{{ item.value.awx_ssh_key }}"
              validate_certs: no
            loop: "{{ lookup('dict', machineCredentials, wantlist=True) }}"
            when: machineCredentials is defined

          - name: Create a valid SCM credential from a private_key file
            awx.awx.credential:
              name: "{{ item.value.name }}"
              organization: "{{ item.value.organization }}"
              state: "{{ item.value.state }}"
              credential_type: Source Control
              inputs:
                ssh_key_data: "{{ item.value.awx_ssh_key }}"
              validate_certs: no
            loop: "{{ lookup('dict', scmCredentials, wantlist=True) }}"
            when: scmCredentials is defined

          - name: Create custom credential type
            awx.awx.credential_type:
              name: "{{ custom_credential_type.value.name }}"
              kind: cloud
              state: "{{ custom_credential_type.value.state }}"
              inputs: "{{ custom_credential_type.value.inputs }}"
              injectors: "{{ custom_credential_type.value.injectors }}"
              validate_certs: false
            loop: "{{ lookup('dict', custom_credential_types, wantlist=True) }}"
            loop_control:
              loop_var: custom_credential_type

          - name: Create custom credential from custom credential type
            awx.awx.credential:
              name: "{{ custom_credential.value.name }}"
              organization: "{{ custom_credential.value.organization }}"
              credential_type: "{{ custom_credential.value.credential_type }}"
              description: "{{ custom_credential.value.description }}"
              state: "{{ custom_credential.value.state }}"
              inputs: "{{ custom_credential.value.inputs }}"
              validate_certs: false
            loop: "{{ lookup('dict', custom_credentials, wantlist=True) }}"
            loop_control:
              loop_var: custom_credential


vars:
  - name: base
    file: |
      ---
      organizations:
        stuttgartThings:
          name: stuttgart-things
          description: stuttgart-things organization
          state: present

      machineCredentials:
        sthingsSSH:
          name: sthings-ssh
          description: stuttgart-things organization
          organization: stuttgart-things
          state: present
          user: sthings
          awx_ssh_key: "{{ lookup('file', '~/.ssh/id_rsa') }}"

      scmCredentials:
        sthingsSCM:
          name: sthings-scm
          organization: stuttgart-things
          state: present
          awx_ssh_key: "{{ lookup('file', '~/.ssh/id_rsa') }}"

      custom_credential_types:
        vault:
          name: vault
          state: present
          inputs: "{{ lookup('file', 'credential_types/vault-input.json') }}"
          injectors: "{{ lookup('file', 'credential_types/vault-injector.json') }}"

      custom_credentials:
        vault_custom:
          name: labul-vault
          description: labul vault credentials
          credential_type: vault
          organization: stuttgart-things
          state: present
          inputs:
            vault_url: "{{ lookup('env', 'VAULT_ADDR') }}"
            vault_token: "{{ lookup('env', 'VAULT_TOKEN') }}"
