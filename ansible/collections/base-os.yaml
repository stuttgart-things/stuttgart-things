---
name: base_os
version: 0.3.7
namespace: sthings
requirements: |
  roles:
    - src: https://github.com/stuttgart-things/download-install-binary.git
      scm: git
      version: 2024.05.24
    - src: https://github.com/stuttgart-things/create-os-user.git
      scm: git
      version: 2024.05.03
    - src: https://github.com/stuttgart-things/install-requirements.git
      scm: git
      version: 2024.05.11
    - src: https://github.com/stuttgart-things/manage-filesystem.git
      scm: git
      version: 2024.05.15
    - src: https://github.com/stuttgart-things/install-configure-vault.git
      scm: git
      version: 2022.01.01
    - src: https://github.com/stuttgart-things/create-send-webhook.git
      scm: git
      version: 2022.01.01
    - src: https://github.com/stuttgart-things/manage-proxmox-resources.git
      scm: git
      version: 2024.05.27

playbooks:

  - name: setup
    play: |
      ---
      - hosts: "{{ target_host | default('all') }}"
        become: true
        gather_facts: true

        vars:
          manage_filesystem: true
          update_packages: true
          install_requirements: true
          install_motd: true
          reboot_all: false
          username: sthings
          lvm_home_sizing: "15%"
          lvm_root_sizing: "35%"
          lvm_var_sizing: "50%"
          send_to_msteams: true
          msteams_webhook_url: "https://365sva.webhook.office.com/webhookb2/2f14a9f8-4736-46dd-9c8c-31547ec37180@0a65cb1e-37d5-41ff-980a-647d9d0e4f0b/IncomingWebhook/37a805a0a2624dc2ac1aedd7dec6ad49/dc3a27ed-396c-40b7-a9b2-f1a2b6b44efe"
          reboot_all: false
          vault_instances:
            - https://vault.tiab.labda.sva.de:8200
            - https://vault.labul.sva.de:8200
            - https://vault-vsphere.labul.sva.de:8200
            - https://vault-pve.labul.sva.de:8200
            - https://vault-vsphere.tiab.labda.sva.de:8200

        roles:
          - role: sthings.base_os.manage_filesystem
            when: manage_filesystem|bool

          - role: sthings.base_os.install_requirements
            when: install_requirements|bool

        pre_tasks:
          - name: Include vars
            ansible.builtin.include_vars: "{{ path_to_vars_file }}.yaml"
            when: path_to_vars_file is defined

          - ansible.builtin.reboot:
            when: reboot_all|bool

        tasks:
          - name: Install vault ca certificate to local system from multiple instances
            ansible.builtin.include_role:
              name: sthings.base_os.install_configure_vault
              tasks_from: install-ca-auth
            vars:
              vault_url: "{{ vault_instance }}"
            loop: "{{ vault_instances }}"
            loop_control:
              loop_var: vault_instance
            when: vault_instances is defined

          - name: Send webhook to msteams
            ansible.builtin.include_role:
              name: sthings.base_os.create_send_webhook
            vars:
              summary_text: base-os-setup was executed
              msteams_url: "https://365sva.webhook.office.com/webhookb2/2f14a9f8-4736-46dd-9c8c-31547ec37180@0a65cb1e-37d5-41ff-980a-647d9d0e4f0b/IncomingWebhook/37a805a0a2624dc2ac1aedd7dec6ad49/dc3a27ed-396c-40b7-a9b2-f1a2b6b44efe"
              card_title: base-os-setup was executed
              act_image: "{{ logo_pic }}"
              act_title: "{{ quotes | random }}"
              act_text: "{{ quotes | random }}"
              os_facts: |
                base-os-setup was executed on "{{ ansible_fqdn }}"
              ms_teams_notification_type: "simple"
            tags: notify
            ignore_errors: true
            when: send_to_msteams|bool

  - name: golang
    play: |
      ---
      - hosts: "{{ target_host | default('all') }}"
        become: true
        vars:
          golang_version: 1.22.3
          golang_checksum: 5fb8b3ed4a78a8eab444dfcb472b8c07a06980dcaee62ce3645edd6d130004c6
          source_url: "https://go.dev/dl/go1.22.3.linux-amd64.tar.gz"
          golang_install_dir: /usr/local
          go_checksum_type: "sha256"

          # USE WITH EXISTING USER
          go_username: sthings
          go_usergroup: sthings
          go_userhome: /home/sthings

          bin:
            golangci-lint:
              bin_name: golangci-lint
              bin_version: 1.58.1
              check_bin_version_before_installing: true
              source_url: "https://github.com/golangci/golangci-lint/releases/download/v1.58.1/golangci-lint-1.58.1-linux-amd64.tar.gz"
              bin_to_copy: golangci-lint-1.58.1-linux-amd64/golangci-lint
              to_remove: golangci-lint-1.58.1-linux-amd64.tar.gz
              bin_dir: "/usr/local/bin"
              version_cmd: "-- version"
              target_version: 1.58.1
            goreleaser:
              bin_name: goreleaser
              bin_version: v1.26.1
              check_bin_version_before_installing: true
              source_url: "https://github.com/goreleaser/goreleaser/releases/download/v1.26.1/goreleaser_Linux_x86_64.tar.gz"
              bin_to_copy: goreleaser
              to_remove: goreleaser_Linux_x86_64.tar.gz
              bin_dir: "/usr/local/bin"
              version_cmd: "-- version"
              target_version: v1.26.1

        pre_tasks:
          - name: Check if Golang is already installed
            ansible.builtin.stat:
              path: "{{ golang_install_dir }}/go"
            register: check_golang

          - name: Get checksum of golang dir
            get_checksum:
              path: "{{ golang_install_dir }}/go"
              checksum_type: "{{ go_checksum_type }}"
            register: checksum_existing
            when: check_golang.stat.exists

          - name: Create golang users
            ansible.builtin.include_role:
              name: create-os-user
            vars:
              users: "{{ golang_users }}"
              groups_to_create: "{{ groups_golang }}"
            when: golang_users is defined

          - name: Unarchive Golang
            ansible.builtin.unarchive:
              src: "{{ source_url }}"
              dest: "{{ golang_install_dir }}/"
              mode: 0755
              validate_certs: false
              remote_src: true
            when: checksum_existing.checksum_value is not defined or golang_checksum != checksum_existing.checksum_value

          - name: Add golang exports for existing users to bashrc
            ansible.builtin.blockinfile:
              block: |
                export GOROOT=/usr/local/go
                export PATH=$GOROOT/bin:$PATH
                export GOPATH=$HOME/usr/local/go
                export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
              dest: "{{ go_userhome }}/.bashrc"
              owner: "{{ go_username }}"
              group: "{{ go_usergroup }}"
              marker_begin: "<!-- BEGIN GOLANG SETUP -->"
              marker_end: "<!-- END GOLANG SETUP -->"
              mode: 0644
              create: true
            when: go_username is defined and go_usergroup is defined and go_userhome is defined

        post_tasks:
          - name: Install addons
            ansible.builtin.shell: |
              ./go install github.com/spf13/cobra-cli@v1.3.0
            args:
              chdir: "{{ golang_install_dir }}/go/bin/"

        roles:
          - role: sthings.base_os.download_install_binary

  - name: binaries
    play: |
      ---
      - hosts: "{{ target_host | default('all') }}"
        become: true
        vars:
          download_dir: "/tmp/downloads"

        vars_files:
          - "{{ profile | default('dev') }}.yaml"

        roles:
          - role: sthings.base_os.download_install_binary

  - name: users
    play: |
      ---
      - hosts: "{{ target_host | default('all') }}"
        gather_facts: true
        become: true
        vars_files:
          - "{{ profile | default('users') }}.yaml"

        roles:
          - role: sthings.base_os.create_os_user

  - name: rename_proxmox_vm
    play: |
      ---
      - hosts: "{{ target_host | default('all') }}"
        vars:
          vault_approle_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"
          vault_approle_secret: "{{ lookup('env', 'VAULT_SECRET_ID') }}"
          vault_url: "{{ lookup('env', 'VAULT_ADDR') }}"

          pve_cluster_url: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=cloud/data/pve:cluster_url validate_certs=false auth_method=approle role_id={{ vault_approle_id }} secret_id={{ vault_approle_secret }} url={{ vault_url }}') }}"
          pve_api_user: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=cloud/data/pve:api_user validate_certs=false auth_method=approle role_id={{ vault_approle_id }} secret_id={{ vault_approle_secret }} url={{ vault_url }}') }}"
          pve_api_password: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=cloud/data/pve:api_password validate_certs=false auth_method=approle role_id={{ vault_approle_id }} secret_id={{ vault_approle_secret }} url={{ vault_url }}') }}"
          pve_node: sthings-pve1

          pve_bulk_rename_vms:
            - current_vm_name: "{{ vmname_old }}"
              expected_vm_name: "{{ vmname_new }}"
              node: "{{ pve_node }}"

        roles:
          - role: sthings.base_os.manage_proxmox_resources

  - name: delete_proxmox_vm
    play: |
      ---
      - hosts: "{{ target_host | default('all') }}"
        vars:
          vault_approle_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"
          vault_approle_secret: "{{ lookup('env', 'VAULT_SECRET_ID') }}"
          vault_url: "{{ lookup('env', 'VAULT_ADDR') }}"

          pve_cluster_url: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=cloud/data/pve:cluster_url validate_certs=false auth_method=approle role_id={{ vault_approle_id }} secret_id={{ vault_approle_secret }} url={{ vault_url }}') }}"
          pve_api_user: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=cloud/data/pve:api_user validate_certs=false auth_method=approle role_id={{ vault_approle_id }} secret_id={{ vault_approle_secret }} url={{ vault_url }}') }}"
          pve_api_password: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=cloud/data/pve:api_password validate_certs=false auth_method=approle role_id={{ vault_approle_id }} secret_id={{ vault_approle_secret }} url={{ vault_url }}') }}"
          pve_node: sthings-pve1

          pve_bulk_delete_vms:
            - name: "{{ vmname_delete }}"
              node: "{{ pve_node }}"

        roles:
          - role: sthings.base_os.manage_proxmox_resources

vars:
  - name: users
    file: |
      ---
      users:
        - username: rke
          name: rke user
          groups: ['{{ admin_group }}', 'k8s-admins']
          uid: 1005
          home: /home/rke
          profile: |
            alias ll='ls -ahl'
          generate_ssh_key: true
          enable_ssh_tcp_forwarding: true

  - name: dev
    file: |
      ---
      bin:
        gh:
          bin_name: gh
          bin_version: "2.49.2"
          check_bin_version_before_installing: true
          source_url: "https://github.com/cli/cli/releases/download/v2.49.2/gh_2.49.2_linux_amd64.tar.gz"
          bin_to_copy: gh_2.49.2_linux_amd64/bin/gh
          to_remove: gh_2.49.2_linux_amd64.tar.gz
          bin_dir: "/usr/local/bin"
          version_cmd: "-- version"
          target_version: 2.49.2
        task:
          bin_name: task
          bin_version: "v3.37.2"
          check_bin_version_before_installing: true
          source_url: "https://github.com/go-task/task/releases/download/v3.37.2/task_linux_amd64.tar.gz"
          bin_to_copy: task
          to_remove: task_linux_amd64.tar.gz
          bin_dir: "/usr/local/bin"
          version_cmd: "-- version"
          target_version: v3.37.2
        terraform:
          bin_name: "terraform"
          bin_version: "1.8.4"
          check_bin_version_before_installing: true
          source_url: "https://releases.hashicorp.com/terraform/1.8.3/terraform_1.8.4_linux_amd64.zip"
          bin_to_copy: "terraform"
          to_remove: "terraform"
          bin_dir: "/usr/local/bin"
          version_cmd: " --version"
          target_version: v1.8.4
        helm:
          bin_name: "helm"
          bin_version: "3.15.1"
          check_bin_version_before_installing: true
          source_url: "https://get.helm.sh/helm-v3.15.0-linux-amd64.tar.gz"
          bin_to_copy: "linux-amd64/helm"
          to_remove: "linux-amd64"
          bin_dir: "/usr/local/bin"
          version_cmd: " version"
          target_version: v3.15.0
          #md5_checksum: "8dd2ecdbb70ef4e3a55083e8d5ebf352"
        kubectl:
          bin_name: "kubectl"
          bin_version: "1.30.1"
          check_bin_version_before_installing: true
          source_url: "https://dl.k8s.io/v1.30.1/bin/linux/amd64/kubectl"
          bin_to_copy: "kubectl"
          to_remove: "kubectl"
          bin_dir: "/usr/local/bin"
          version_cmd: " version --client"
          target_version: v1.30.1
          #md5_checksum: "07b43208389cbc779941b94a05cf89bc"
        packer:
          bin_name: "packer"
          bin_version: "1.10.3"
          check_bin_version_before_installing: true
          source_url: "https://releases.hashicorp.com/packer/1.10.3/packer_1.10.3_linux_amd64.zip"
          bin_to_copy: "packer"
          to_remove: "packer"
          bin_dir: "/usr/local/bin"
          version_cmd: " --version"
          target_version: v1.10.2
          #md5_checksum: "374f22185f1f8cb25bc53187a2154ef0"
        k9s:
          bin_name: "k9s"
          bin_version: "0.32.4"
          check_bin_version_before_installing: true
          source_url: "https://github.com/derailed/k9s/releases/download/v0.32.4/k9s_Linux_amd64.tar.gz"
          bin_to_copy: "k9s"
          to_remove: "k9s"
          bin_dir: "/usr/local/bin"
          version_cmd: " version --short"
          target_version: v0.32.4
          #md5_checksum: "04ba6f524a433f8ceb9095c4c8292240"
        velero:
          bin_name: velero
          bin_version: 1.13.2
          check_bin_version_before_installing: true
          source_url: "https://github.com/vmware-tanzu/velero/releases/download/v1.13.2/velero-v1.13.2-linux-amd64.tar.gz"
          bin_to_copy: "velero-v1.13.2-linux-amd64/velero"
          to_remove: "velero-v1.13.2-linux-amd64"
          bin_dir: "/usr/local/bin"
          version_cmd: " version --client-only"
          target_version: v1.13.2
          #md5_checksum: "30ab57f9520ae2318ab28eefbc81728c"
        yq:
          bin_name: yq
          bin_version: 4.43.1
          check_bin_version_before_installing: true
          source_url: "https://github.com/mikefarah/yq/releases/download/v4.43.1/yq_linux_amd64.tar.gz"
          bin_to_copy: yq
          to_remove: ""
          bin_dir: "/usr/bin"
          version_cmd: " version"
          target_version: 4.43.1
        machineshop:
          bin_name: machineshop
          bin_version: 1.9.9
          check_bin_version_before_installing: true
          source_url: https://github.com/stuttgart-things/machineshop/releases/download/1.9.9/machineshop_Linux_x86_64.tar.gz
          bin_to_copy: machineshop
          to_remove: ""
          bin_dir: "/usr/bin"
          version_cmd: " version"
          target_version: 1.9.9
