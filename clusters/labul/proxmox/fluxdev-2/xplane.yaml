---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: xplane-registry
  namespace: flux-system
spec:
  interval: 1h
  retryInterval: 1m
  timeout: 5m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./apps/crossplane-app
  prune: true
  wait: true
  postBuild:
    substitute:
      XPLANE_APP: registry
      XPLANE_APP_PACKAGE_URL: ghcr.io/stuttgart-things/stuttgart-things/xplane-registry
      XPLANE_APP_PACKAGE_TAG: 2.2.3
  patches:
    - patch: |-
        - op: add
          path: /spec/values/
          value:
            customresources:
              registry-claim:
                apiVersion: resources.stuttgart-things.com/v1alpha1
                kind: Registry
                metadata:
                  name: registry-kubernetes-incluster
                  namespace: crossplane-system
                spec:
                  clusterName: kubernetes-incluster
                  deploymentNamespace: fluxdev-2.sthings-vsphere.labul.sva.de
                  domainName: registry
                  storageClass: nfs4-csi
                  storageSize: 2Gi
                  version: 2.2.3
                  cert:
                    secretName: registry-ingress-tls
                    issuerName: cluster-issuer-approle
      target:
        kind: HelmRelease
        name: crossplane-app-claim-registry
        namespace: crossplane-system