---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: xplane-registry
  namespace: flux-system
spec:
  interval: 1h
  retryInterval: 1m
  timeout: 5m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./apps/crossplane-app
  prune: true
  wait: true
  postBuild:
    substitute:
      XPLANE_APP: registry
      XPLANE_APP_PACKAGE_URL: ghcr.io/stuttgart-things/stuttgart-things/xplane-registry
      XPLANE_APP_PACKAGE_TAG: 2.2.3
  patches:
    - target:
        kind: HelmRelease
        name: crossplane-app-claim-registry
        namespace: crossplane-system
      patch: |-
        - op: replace
          path: /spec/values/customresources/claim/spec/cert/-
          value:
            secretName: registry-ingress-tls
            issuerName: cluster-issuer-approle
