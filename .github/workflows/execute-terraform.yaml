---
name: Execute Terraform
on:
  workflow_call:
    inputs:
      folder:
        required: true
        type: string
      branch:
        required: true
        type: string
      operation:
        required: false
        type: string
        default: apply
      runs-on:
        required: true
        type: string
      environment-name:
        default: k8s
        required: false
        type: string
      working-image:
        type: string
        default: eu.gcr.io/stuttgart-things/sthings-terraform:1.8.1-1
        required: false

jobs:
  execute-terraform:
    runs-on: ${{ inputs.runs-on }}
    environment: ${{ inputs.environment-name }}
    container:
      image: ${{ inputs.working-image }}
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: '0'
          ref: ${{ inputs.branch }}

      - name: Import Secrets
        id: import-secrets
        uses: hashicorp/vault-action@v2
        with:
          url: https://vault-vsphere.labul.sva.de:8200
          token: ${{ secrets.VAULT_TOKEN }}
          caCertificate: ${{ secrets.VAULT_CA_CERT }}
          secrets: |
            apps/data/rancher accessKey | RANCHER_ACCESS_KEY_ID ;

      - name: Step following 'Import Secrets'
        run: |
          RANCHER_ACCESS_KEY_ID = "${{ env.RANCHER_ACCESS_KEY_ID }}"
          echo ${RANCHER_ACCESS_KEY_ID} > test.yaml

      - name: Upload VM variables
        id: upload
        uses: actions/upload-artifact@v4.1.0
        with:
          name: test
          path: test.yaml

      - name: Terraform init
        run: |
          ls -lta ${{ inputs.folder }}
          terraform --version
          terraform -chdir=${{ inputs.folder }} init
        shell: bash
