---
name: Execute Terraform
on:
  workflow_call:
    inputs:
      folder:
        required: true
        type: string
      branch:
        required: true
        type: string
      operation:
        required: false
        type: string
        default: apply
      runs-on:
        required: true
        type: string
      environment-name:
        default: k8s
        required: false
        type: string
      working-image:
        type: string
        default: eu.gcr.io/stuttgart-things/sthings-terraform:1.8.1-2
        required: false

jobs:
  execute-terraform:
    runs-on: ${{ inputs.runs-on }}
    environment: ${{ inputs.environment-name }}
    container:
      image: ${{ inputs.working-image }}
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
      TFVARS_FILE: ${{ inputs.folder }}/terraform.tfvars
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: '0'
          ref: ${{ inputs.branch }}

      - name: Render terraform.tfvars (if exists)
        run: |
          if test -f "${TFVARS_FILE}"; then
            echo "${TFVARS_FILE} exists."
            tail -1 ${TFVARS_FILE}| cut -c 3-
          fi

      - name: Terraform init
        run: |
          ls -lta ${{ inputs.folder }}
          terraform --version
          terraform -chdir=${{ inputs.folder }} init
        shell: bash
