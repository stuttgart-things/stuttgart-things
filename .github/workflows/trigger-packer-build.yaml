name: Build Packer Template
on:
  pull_request:
    types:
      - opened
      - reopened

jobs:
  Get-Packer-Config:
    if: contains(github.event.pull_request.labels.*.name, 'packer')
    outputs:
      lab: ${{ steps.set.outputs.LAB }}
      cloud: ${{ steps.set.outputs.CLOUD }}
      os-version: ${{ steps.set.outputs.OS_VERSION }}
      build-date: ${{ steps.set.outputs.BUILD_DATE }}
    container:
      image: eu.gcr.io/stuttgart-things/machineshop:v1.7.2
    runs-on: ghr-stuttgart-things-sthings-cicd
    steps:
      - name: Set Build Details
        id: set
        run: |
          echo "OS_VERSION=$(echo ${{ github.event.pull_request.head.ref }} | cut -d '-' -f 1)" >> "$GITHUB_OUTPUT"
          echo "LAB=$(echo ${{ github.event.pull_request.head.ref }} | cut -d '-' -f 2)" >> "$GITHUB_OUTPUT"
          echo "CLOUD=$(echo ${{ github.event.pull_request.head.ref }} | cut -d '-' -f 3)" >> "$GITHUB_OUTPUT"
          echo "BUILD_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

  Build-Packer-Template:
    needs: Get-Packer-Config
    runs-on: ghr-stuttgart-things-sthings-cicd
    environment: ${{ needs.Get-Packer-Config.outputs.lab }}-${{ needs.Get-Packer-Config.outputs.cloud }}
    container:
      image: eu.gcr.io/stuttgart-things/sthings-packer:1.10.2-9.4.0-2
    env:
      PACKER_LOG_PATH: packer.log
      PACKER_LOG: 1
      PACKER_BUILD_PATH: packer/builds/
    steps:
      - name: Show app versions
        id: versions
        run: |
          packer --version
          ansible --version

      - name: Checkout code/branch
        id: checkout
        uses: actions/checkout@v4

      - name: Packer build
        id: build
        run: |
          cd ${PACKER_BUILD_PATH}/${{ github.event.pull_request.head.ref }}/
          ls -lta

          packer init $(ls *.hcl)
          
          packer build -force \
          -var "username=${{ secrets.USERNAME }}" \
          -var "password=${{ secrets.PASSWORD }}" \
          -var "name=${{ needs.Get-Packer-Config.outputs.os-version }}-${{ needs.Get-Packer-Config.outputs.build-date }}" \
          $(ls *.hcl)

      - name: Upload Packer logfile
        id: upload
        uses: actions/upload-artifact@v4.1.0
        with:
          name: ${{ needs.Get-Packer-Config.outputs.lab }}-${{ needs.Get-Packer-Config.outputs.cloud }}-${{ needs.Get-Packer-Config.outputs.os-version }}-${{ needs.Get-Packer-Config.outputs.build-date }}.log
          path: packer/builds/${{ github.event.pull_request.head.ref }}/packer.log
