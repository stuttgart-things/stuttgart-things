---
name: Dispatch Terraform Flux
on:
  workflow_dispatch:
    inputs:
      lab:
        type: choice
        description: LAB
        options:
          - labul
          - labda
          - labul
      cloud:
        type: choice
        description: CLOUD
        options:
          - vsphere
          - proxmox
      cluster-name:
        required: true
        type: string
      environment-name:
        type: choice
        description: ENVIRONMENT
        options:
          - k8s
          - labul-vsphere
          - labda-vsphere
          - labul-proxmox
      working-image:
        description: WORKING IMAGE
        type: string
        default: ghcr.io/stuttgart-things/machineshop/machineshop-9c3178088556daa12a17db5edcc6b5b7@sha256:fff62c5ad6d02db52f0525519cddcf1833cf59201e44e3f5c77befbd492cc60a
      runner:
        description: RUNNER NAME
        required: true
        type: string
        default: ghr-stuttgart-things-labul-automation
jobs:
  Create-Flux-Config:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ${{ inputs.runner }}
    environment: ${{ inputs.environment-name }}
    container:
      image: ${{ inputs.working-image }}
    env:
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
    continue-on-error: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.7
        with:
          fetch-depth: '0'

      - name: Set config variables
        id: set
        run: |
          echo TF_PROJECT_DIR="terraform/flux/${{ inputs.lab }}-${{ inputs.cloud }}-${{ inputs.cluster-name }}" >> $GITHUB_ENV
          echo FLUX_DEFAULTS_CONFIG="terraform/defaults.yaml" >> $GITHUB_ENV
          echo FLUX_BOOTSTRAP_TEMPLATE="terraform/flux.tf.tpl" >> $GITHUB_ENV
          echo FLUX_STATE_TEMPLATE="terraform/state-provider.tf.tpl" >> $GITHUB_ENV

      - name: Create Flux config dir
        id: configDir
        run: |
          mkdir -p ${{ env.TF_PROJECT_DIR }}

      - name: Render Flux bootstrap config
        id: renderBootstrapConfig
        run: |
          machineshop render \
          --source local \
          --template ${{ env.FLUX_BOOTSTRAP_TEMPLATE }} \
          --defaults ${{ env.FLUX_DEFAULTS_CONFIG }} \
          --values "lab=${{ inputs.lab }}, cloud=${{ inputs.cloud }}, clusterName=${{ inputs.cluster-name }}" \
          --output file \
          --destination ${{ env.TF_PROJECT_DIR }}/flux.tf

      - name: Render Flux bootstrap config
        id: renderStateConfig
        run: |
          machineshop render \
          --source local \
          --template ${{ env.FLUX_STATE_TEMPLATE }} \
          --defaults ${{ env.FLUX_DEFAULTS_CONFIG }} \
          --values "stateKey=${{ inputs.cluster-name }}" \
          --output file \
          --destination ${{ env.TF_PROJECT_DIR }}/state.tf

      # - name: Get token for creating pull request
      #   uses: tibdex/github-app-token@v2
      #   id: generate-token
      #   with:
      #     app_id: ${{ secrets.PULLREQUESTER_APP_ID }}
      #     private_key: ${{ secrets.PULLREQUESTER_APP_KEY }}

      - name: Create branch for flux config
        id: createBranch
        run: |
          machineshop create \
          --kind branch \
          --branch ${{ env.TF_PROJECT_DIR }} \
          --repository stuttgart-things \
          --group stuttgart-things \
          --files "${{ env.TF_PROJECT_DIR }}/flux.tf:${{ env.TF_PROJECT_DIR }}/flux.tf,${{ env.TF_PROJECT_DIR }}/state.tf:${{ env.TF_PROJECT_DIR }}/state.tf" \

      - name: Create pr for (newly created) flux branch into main
        id: createPR
        run: |
          machineshop create \
          --kind pr \
          --title "flux bootstrap terraform code for cluster ${{ inputs.cluster-name }} on lab ${{ inputs.lab }}-${{ inputs.cloud }} created" \
          --branch ${{ env.TF_PROJECT_DIR }} \
          --repository stuttgart-things \
          --group stuttgart-things \
          --branch ${{ env.TF_PROJECT_DIR }} \
          --tags test


      # - name: Create Pull Request for flux config
      #   id: pr
      #   uses: peter-evans/create-pull-request@v6.1.0
      #   with:
      #     commit-message: '[CI][Created cluster configuration for flux ${{ inputs.cluster-name }}'
      #     title: flux cluster configuration ${{ inputs.cluster-name }} created
      #     branch: ${{ env.TF_PROJECT_DIR }}
      #     delete-branch: true
      #     token: ${{ steps.generate-token.outputs.token }}
      #     labels: |
      #       flux

      # - name: Comment ansible provisioning to PR as post-label
      #   uses: thollander/actions-comment-pull-request@v2
      #   with:
      #     pr_number: ${{ steps.pr.outputs.pull-request-number }}"
      #     message: |
      #       :wave: post: ${{ inputs.ansible-provisioning }}

  Send-Homerun-Notification:
    if: ${{ always() }}
    needs: Create-Flux-Config
    runs-on: ${{ inputs.runner }}
    environment: ${{ inputs.environment-name }}
    container:
      image: ${{ inputs.working-image }}
    steps:
      - name: Send notification to homerun w/ machineshop
        shell: bash
        run: |
          TITLE_PREFIX="PullRequest for bootstrap cluster: ${{ inputs.cluster-name }} w/ flux on github"
          SYSTEM="terraform"
          TAGS="flux, terraform, github-actions"
          WORKFLOW_RESULT="created successfully"
          WORKFLOW_SEVERITY="SUCCESS"
          BODY="REPOSITORY: ${GITHUB_REPOSITORY} WORKFLOW: ${GITHUB_WORKFLOW} ARTIFACT: ${{ inputs.cluster-name }} ${{ inputs.lab-cloud }} RUNNER_NAME: ${RUNNER_NAME} WORKFLOW-IMAGE: ${{ inputs.working-image }} ENV: ${{ inputs.environment-name }}"

          if [ "${{ needs.Create-Flux-Config.result }}" != "success" ]; then
            WORKFLOW_RESULT="failed to create"
            WORKFLOW_SEVERITY="ERROR"
          fi

          TITLE="${TITLE_PREFIX} ${WORKFLOW_RESULT}"

          machineshop push \
          --destination https://homerun.homerun-dev.sthings-vsphere.labul.sva.de/generic \
          --target homerun \
          --title "${TITLE}" \
          --system "${SYSTEM}" \
          --info "${BODY}" \
          --tags "${TAGS}" \
          --author "${GITHUB_ACTOR}" \
          --severity "${WORKFLOW_SEVERITY}"