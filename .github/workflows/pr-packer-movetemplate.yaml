name: PR Move Packer Template
on:
  pull_request:
    types:
      - opened
      - reopened

jobs:
  Get-Packer-Config:
    if: contains(github.event.pull_request.labels.*.name, 'move-packer-template')
    outputs:
      runs-on: ${{ steps.set.outputs.RUNS_ON }}
      cloud: ${{ steps.set.outputs.CLOUD }}
      lab: ${{ steps.set.outputs.LAB }}
      working-image: ${{ steps.set.outputs.WORKING_IMAGE }}
    container:
      image: eu.gcr.io/stuttgart-things/machineshop:v1.7.2
    permissions:
      contents: read
      pull-requests: read
    runs-on: ghr-stuttgart-things-sthings-cicd
    steps:
      - name: Get VM-Template name
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: successful

      - name: Set values for govc operation
        id: set
        run: |
          OS=$(echo ${{ github.event.pull_request.head.ref }} | cut -d'-' -f1)
          LAB=$(echo ${{ github.event.pull_request.head.ref }} | cut -d'-' -f2)
          CLOUD=$(echo ${{ github.event.pull_request.head.ref }} | cut -d'-' -f3)

          echo "CLOUD=${CLOUD}" >> $GITHUB_OUTPUT
          echo "LAB=${LAB}" >> $GITHUB_OUTPUT
          echo "OS=${OS}" >> $GITHUB_OUTPUT
          echo "RUNS_ON=ghr-stuttgart-things-sthings-cicd" >> $GITHUB_OUTPUT
          echo "WORKING_IMAGE=eu.gcr.io/stuttgart-things/sthings-packer:1.10.2-9.4.0-2" >> $GITHUB_OUTPUT
        shell: bash

  Move-Vsphere-Template:
    needs: Get-Packer-Config
    runs-on: ${{ needs.Get-Packer-Config.outputs.runs-on }}
    environment: ${{ needs.Get-Packer-Config.outputs.lab }}-${{ needs.Get-Packer-Config.outputs.cloud }}
    container:
      image: ${{ needs.Get-Packer-Config.outputs.working-image }}
    env:
      GOVC_INSECURE: TRUE
      VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
      VAULT_AUTH_METHOD: ${{ secrets.VAULT_AUTH_METHOD }}
      VAULT_NAMESPACE: ${{ secrets.VAULT_NAMESPACE }}
      VAULT_ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
      VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
    steps:
      - name: Set GOVC_URL to env
        id: set
        run: |
          USER=$(machineShop get --path cloud/data/vsphere:username | tail -n +8)
          PW=$(machineShop get --path cloud/data/vsphere:username | tail -n +8)
          echo "GOVC_URL=https://${USER}:${PW}@10.31.101.51/sdk" >> $GITHUB_ENV
    
      - name: Move vsphere template
        id: move
        run: |
          govc ls
          # govc object.rename /LabUL/vm/stuttgart-things/packer/ubuntu23-2024-04-30-base-os ubuntu23
