---
name: Build & Create Packer PipelineRun
on:
  #push:
   # branches:
    #  - 'main'
  workflow_dispatch:
    inputs:
      os-version:
        type: choice
        description: OS-VERSION
        options:
          - ubuntu23
          - rocky9
      ansible-provisioning:
        type: choice
        description: ANSIBLE-PROVISIONING
        options:
          - baseos
          - clusternode
      env:
        type: choice
        description: ENV
        options:
          - labda
          - labul
          - labul
      branch-name:
        required: true
        type: string
          
jobs:
  Packer-Cronjob:
    runs-on: arc-runner-scale-set-stuttgart-things
    container:
      image: eu.gcr.io/stuttgart-things/machineshop:v0.1.53-git
    environment: k8s
    continue-on-error: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
      - run: |
          ls -lta
          machineShop version
          git config --global --add safe.directory '*'
          machineShop render --source local --template machineShop/templates/packer-u23-vsphere.yaml --values "provisioning=baseos, date=$(date '+%Y-%m-%d-%H-%M-%S'), dateShort=$(date '+%Y-%m-%d'), env=${{ inputs.env }}"
      - name: Commit changes
        uses: EndBug/add-and-commit@v9.1.3
        with:
          author_name: Patrick Hermann
          author_email: patrick.hermann@sva.de
          message: 'added packer template for ${{ inputs.env }}'
          add: '*'
          new_branch: ${{ inputs.branch-name }}

#jobs:
#  Packer-PipelineRun-Creation:
#    runs-on: arc-runner-scale-set-stuttgart-things
#    container:
#      image: eu.gcr.io/stuttgart-things/machineshop:v0.1.53-git
#    environment: k8s
#    continue-on-error: false
#    permissions:
#      contents: write
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4.1.1
#      - run: |
#          machineShop version
#          git config --global --add safe.directory '*'
#          echo 'hello' >> test.txt
#      - name: Commit changes
#        uses: EndBug/add-and-commit@v9.1.3
#        with:
#          author_name: Patrick Hermann
#          author_email: patrick.hermann@sva.de
#          message: 'updated vars for LabUL'
#          add: '*'
#          new_branch: custom-new-branch
