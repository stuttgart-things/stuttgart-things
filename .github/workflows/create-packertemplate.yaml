---
name: Create Packer Template
on:
  workflow_dispatch:
    inputs:
      os-version:
        type: choice
        description: os version
        options:
          - ubuntu23
      cloud:
        type: choice
        description: cloud
        options:
          - vsphere
          - proxmox
     lab:
        type: choice
        description: lab
        options:
          - labda
          - labul
      runner:
        description: RUNNER NAME
        required: true
        type: string
        default: ghr-stuttgart-things-sthings-cicd
jobs:
  Create-Packer-Config:
    runs-on: ${{ inputs.runner }}
    environment: k8s
    container:
      image: eu.gcr.io/stuttgart-things/machineshop:v1.7.2
    continue-on-error: false
    steps:
      - name: Checkout code
        id: checkout
        uses: actions/checkout@v4.1.1

      - name: test
        id: test
        run: |
          echo ${{ inputs.os-version }}
          echo ${{ inputs.cloud }}
          echo ${{ inputs.lab }}
          ls

          # RENDER PACKER-CONFIG
          machineShop render \
          --source local \
          --template packer/template/${{ inputs.os-version }}-${{ inputs.cloud }}.pkr.tpl.hcl \
          --defaults packer/environments/${{ inputs.cloud }}-${{ inputs.cloud }}.yaml \
          --brackets square \
          --values "vmTemplateName=${{ inputs.os-version }}, packerConfigMountPath=/home/sthings/packer/u23-${{ inputs.cloud }}-${{ inputs.cloud }}, ansiblePlayMountPath=/home/sthings/packer/u23-${{ inputs.cloud }}-${{ inputs.cloud }}, ansibleOsProvioning=base-os, osVersion=${{ inputs.os-version }}" \
          --output stdout
