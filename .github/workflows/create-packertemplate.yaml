---
name: Create Packer Template
on:
  workflow_dispatch:
    inputs:
      os-version:
        type: choice
        description: os version
        options:
          - ubuntu23
      cloud:
        type: choice
        description: cloud
        options:
          - vsphere
          - proxmox
      lab:
        type: choice
        description: lab
        options:
          - labda
          - labul
      runner:
        description: RUNNER NAME
        required: true
        type: string
        default: ghr-stuttgart-things-sthings-cicd
jobs:
  Create-Packer-Config:
    runs-on: ${{ inputs.runner }}
    environment: k8s
    container:
      image: eu.gcr.io/stuttgart-things/machineshop:v1.7.2
    continue-on-error: false
    steps:
      - name: Checkout code
        id: checkout
        uses: actions/checkout@v4.1.1

      - name: create Folder
        id: createFolder
        run: |
          echo "WORKING_DIR=packer/builds/${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}" >> $GITHUB_ENV
          mkdir -p ${{ env.WORKING_DIR }}

      - name: RENDER OS-TEMPLATE w/ machineShop
        id: renderOsTemplate
        run: |
          echo ${{ inputs.os-version }}
          echo ${{ inputs.cloud }}
          echo ${{ inputs.lab }}
          ls

          # RENDER PACKER-CONFIG
          machineShop render \
          --source local \
          --template packer/template/${{ inputs.os-version }}-${{ inputs.cloud }}.pkr.tpl.hcl \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --brackets square \
          --values "vmTemplateName=${{ inputs.os-version }}, packerConfigMountPath=/home/sthings/packer/${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}, ansiblePlayMountPath=/home/sthings/packer/${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}, ansibleOsProvioning=base-os, osVersion=${{ inputs.os-version }}" \
          --destination ${{ env.WORKING_DIR }}//ubuntu23.pkr.hcl \
          --output file

      - name: RENDER KICKSTART w/ machineShop
        id: renderKickstart
        run: |
          machineShop render \
          --source local \
          --template packer/kickstart/ubuntu-${{ inputs.cloud }}.yaml \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --output file \
          --destination ${{ env.WORKING_DIR }}/user-data

      - name: RENDER PLAYBOOK w/ machineShop base-os
        id: renderBase-os
        run: |
          machineShop render \
          --source local \
          --template packer/ansible/play.yaml \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --output file \
          --brackets square \
          --destination ${{ env.WORKING_DIR }}/base-os.yaml

      - name: RENDER PLAYBOOK w/ machineShop requirements
        id: renderRequirements
        run: |
          machineShop render \
          --source local \
          --template packer/ansible/requirements.yaml \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --output file \
          --brackets square \
          --destination ${{ env.WORKING_DIR }}/requirements.yaml
