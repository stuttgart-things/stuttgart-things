---
name: Create Packer Template
on:
  workflow_dispatch:
    inputs:
      os-version:
        type: choice
        description: os version
        options:
          - ubuntu23
      cloud:
        type: choice
        description: cloud
        options:
          - vsphere
          - proxmox
      lab:
        type: choice
        description: lab
        options:
          - labda
          - labul
      ansible-provisioning:
        type: choice
        description: provisioning
        options:
          - base-os
      packer-version:
        type: choice
        description: packer version
        required: true
      runner:
        description: RUNNER NAME
        required: true
        type: string
        default: ghr-stuttgart-things-sthings-cicd
jobs:
  Create-Packer-Config:
    runs-on: ${{ inputs.runner }}
    environment: k8s
    container:
      image: eu.gcr.io/stuttgart-things/machineshop:v1.7.2
    continue-on-error: false
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: CHECKOUT CODE
        id: checkout
        uses: actions/checkout@v4.1.1

      - name: CREATE WORKINGDIR
        id: createFolder
        run: |
          echo "WORKING_DIR=packer/builds/${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}" >> $GITHUB_ENV
          mkdir -p packer/builds/${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}

      - name: CREATE METADATA
        id: createMetadata
        run: touch ${{ env.WORKING_DIR }}/meta-data

      - name: RENDER OS-TEMPLATE w/ machineShop
        id: renderOsTemplate
        run: |
          echo ${{ inputs.os-version }}
          echo ${{ inputs.cloud }}
          echo ${{ inputs.lab }}
          ls

          # RENDER PACKER-CONFIG
          machineShop render \
          --source local \
          --template packer/template/${{ inputs.os-version }}-${{ inputs.cloud }}.pkr.tpl.hcl \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --brackets square \
          --values "vmTemplateName=${{ inputs.os-version }}, packerConfigMountPath=., ansiblePlayMountPath=., ansibleOsProvioning=${{ inputs.ansible-provisioning }}, osVersion=${{ inputs.os-version }}" \
          --destination ${{ env.WORKING_DIR }}//ubuntu23.pkr.hcl \
          --output file

      - name: RENDER KICKSTART w/ machineShop
        id: renderKickstart
        run: |
          machineShop render \
          --source local \
          --template packer/kickstart/ubuntu-${{ inputs.cloud }}.yaml \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --output file \
          --destination ${{ env.WORKING_DIR }}/user-data

      - name: RENDER PLAYBOOK w/ machineShop base-os
        id: renderBase-os
        run: |
          machineShop render \
          --source local \
          --template packer/ansible/play.yaml \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --output file \
          --brackets square \
          --destination ${{ env.WORKING_DIR }}/base-os.yaml

      - name: RENDER PLAYBOOK w/ machineShop requirements
        id: renderRequirements
        run: |
          machineShop render \
          --source local \
          --template packer/ansible/requirements.yaml \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --output file \
          --brackets square \
          --destination ${{ env.WORKING_DIR }}/requirements.yaml

      - name: RENDER README-TEMPLATE w/ machineShop
        id: renderOsTemplate
        run: |
          machineShop render \
          --source local \
          --template packer/README.md.tpl \
          --output file \
          --values "packerVersion=${{ inputs.packer-version }}, osVersion=${{ inputs.os-version }}, lab=${{ inputs.lab }}, cloud=${{ inputs.cloud }}" \
          --destination /home/openlab/packer/u23-labda-vsphere/README.md

      - name: Create Pull Request
        id: pr
        uses: peter-evans/create-pull-request@v6.0.1
        with:
          commit-message: '[CI][PACKER] - Created template config for vm ${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}'
          title: 'Created packer template'
          branch: ${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}
