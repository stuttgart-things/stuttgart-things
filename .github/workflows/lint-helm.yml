name: Validate helm chart

on:
  workflow_dispatch:
    inputs:
      dev-cleanup:
        description: "Dev: Check to enable deletion of the deployment"
        required: false
        type: boolean
        default: false

  push:
    branches: [ main ]

jobs:
  Init:
    name: Init
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: substitute project name
        run: echo project_name=${GITHUB_REPOSITORY#*/} >> $GITHUB_ENV
        id: project_name

      - name: substitute branch name
        id: branch_name
        run: |
          # get branch name
          if [ -z "$SOURCE_BRANCH" ]
          then
            export BRANCH_TMP=${GITHUB_REF##*/}
          else
            export BRANCH_TMP=${SOURCE_BRANCH##*/}
          fi
          # export lowercase
          export BRANCH_LOWER=${BRANCH_TMP,,}
          echo branch_name=${BRANCH_LOWER} >> $GITHUB_ENV
          echo branch_name_limited=${BRANCH_LOWER:0:30} >> $GITHUB_ENV
        env:
          SOURCE_BRANCH: ${{ github.head_ref }}
    outputs:
      project_name: ${{ env.project_name }}
      branch_name: ${{ env.branch_name }}

  # USE IN MAIN BRANCH ONLY
  Linting-staging:
    if: github.event.ref == 'refs/heads/main'
    name: Staging
    needs:
      - Init
    uses: ./.github/workflows/workflow.yml
    with:
      environment-name: dev
      cancel-concurrent: false
      branch-name: ${{ needs.Init.outputs.branch_name }}
    secrets: inherit

  # PRODUCTION DEPLOYMENT
  # STAGING HAS APPROVAL STEP
  Linting-production:
    name: Production
    needs:
      - Init
      - Linting-staging
    uses: ./.github/workflows/workflow.yml
    with:
      environment-name: production
      cancel-concurrent: true
      branch-name: ${{ needs.Init.outputs.branch_name }}
    secrets: inherit