name: Validate helm chart
on:
 push:
   branches: [ main ]

jobs:
  Init:
    name: Init
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: substitute branch name
        id: branch_name
        run: |
          # get branch name
          if [ -z "$SOURCE_BRANCH" ]
          then
            export BRANCH_TMP=${GITHUB_REF##*/}
          else
            export BRANCH_TMP=${SOURCE_BRANCH##*/}
          fi
          # export lowercase
          export BRANCH_LOWER=${BRANCH_TMP,,}
          echo branch_name=${BRANCH_LOWER} >> $GITHUB_ENV
          echo branch_name_limited=${BRANCH_LOWER:0:30} >> $GITHUB_ENV
        env:
          SOURCE_BRANCH: ${{ github.head_ref }}

  # USE IN MAIN BRANCH ONLY
  Linting-staging:
    if: github.event.ref == 'refs/heads/main'
    name: Staging
    needs:
      - Init
    uses: ./.github/workflows/workflow.yml
    with:
      environment-name: dev
    secrets: inherit

  # PRODUCTION DEPLOYMENT
  Linting-production:
    name: Production
    needs:
      - Init
      - Linting-staging
    uses: ./.github/workflows/workflow.yml
    with:
      environment-name: production
    secrets: inherit