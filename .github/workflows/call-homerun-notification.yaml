---
name: Send homerun notification
on:
  workflow_call:
    inputs:
      notification-title:
        default: "unset"
        type: string
        required: false
      notification-severity:
        default: "unset"
        type: string
        required: false
      notification-info:
        default: "unset"
        type: string
        required: false
      notification-url:
        default: "https://homerun.homerun-dev.sthings-vsphere.labul.sva.de/generic"
        type: string
        required: false
      notification-tags:
        default: "unset"
        type: string
        required: false
      notification-author:
        default: "unset"
        type: string
        required: false
      runs-on:
        type: string
        default: ghr-stuttgart-things-labul-automation
        required: false
      environment-name:
        default: k8s
        type: string
        required: false
      machineshop-image:
        default: ghcr.io/stuttgart-things/machineshop/machineshop-9c3178088556daa12a17db5edcc6b5b7@sha256:0aa1134306ca79c47141f05ede01afb373dcea3aab76175ac897b6b89ce4342c
        type: string
        required: false
      continue-on-error:
        default: true
        type: boolean
        required: false

jobs:
  Send-Homerun-Notification:
    runs-on: ${{ inputs.runs-on }}
    container:
      image: ${{ inputs.machineshop-image }}
    environment: ${{ inputs.environment-name }}
    continue-on-error: ${{ inputs.continue-on-error }}
    steps:
      - name: Send notification to homerun
        run: |
          printenv

          SYSTEM="github"
          WORKFLOW_RESULT="failed"
          WORKFLOW_SEVERITY="ERROR"
          AUTHOR="${GITHUB_ACTOR}"
          TAGS="github-actions"
          MESSAGE_BODY="REPOSITORY: ${GITHUB_REPOSITORY} WORKFLOW: ${GITHUB_WORKFLOW} ARTIFACT: ? BUILD-PARAMETER: ? w/ RUNNER_NAME: ${RUNNER_NAME} ENV: ?"

          if [ "${{ inputs.notification-info }}" != "unset" ]; then
            WORKFLOW_RESULT="successful"
            WORKFLOW_SEVERITY="SUCCESS"
            MESSAGE_BODY="${{ inputs.notification-info }}"
          fi

          TITLE="Workflow ${GITHUB_WORKFLOW} on ${SYSTEM} was ${WORKFLOW_RESULT}"

          if [ "${{ inputs.notification-title }}" != "unset" ]; then
            TITLE="${{ inputs.notification-title }}"
          fi

          if [ "${{ inputs.notification-author }}" != "unset" ]; then
            AUTHOR="${{ inputs.notification-author }}"
          fi

          if [ "${{ inputs.notification-tags }}" != "unset" ]; then
            TAGS="${{ inputs.notification-tags }}"
          fi

          echo TITLE: ${TITLE}
          echo SYSTEM: ${SYSTEM}
          echo SEVERITY: ${WORKFLOW_SEVERITY}
          echo RESULT: ${WORKFLOW_RESULT}
          echo AUTHOR: ${AUTHOR}
          echo TAGS: ${TAGS}

          machineshop push \
          --destination ${{ inputs.notification-url }} \
          --target homerun \
          --title "${TITLE}" \
          --system "${SYSTEM}" \
          --info "${MESSAGE_BODY}" \
          --tags "${TAGS}" \
          --author "${AUTHOR}" \
          --severity "${WORKFLOW_SEVERITY}"