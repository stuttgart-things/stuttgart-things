---
name: Create Packer Config
on:
  workflow_dispatch:
    inputs:
      os-version:
        type: choice
        description: os version
        options:
          - ubuntu23
      cloud:
        type: choice
        description: cloud
        options:
          - vsphere
          - proxmox
      lab:
        type: choice
        description: lab
        options:
          - labda
          - labul
      ansible-provisioning:
        type: choice
        description: provisioning
        options:
          - base-os
      packer-version:
        type: string
        description: packer version
        default: 1.10.2
      runner:
        description: RUNNER NAME
        required: true
        type: string
        default: ghr-stuttgart-things-sthings-cicd
jobs:
  Create-Packer-Config:
    runs-on: ${{ inputs.runner }}
    environment: k8s
    container:
      image: eu.gcr.io/stuttgart-things/machineshop:v1.7.2
    continue-on-error: false
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        id: checkout
        uses: actions/checkout@v4.1.1

      - name: Create workingdir
        id: createFolder
        run: |
          echo "WORKING_DIR=packer/builds/${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}" >> $GITHUB_ENV
          mkdir -p packer/builds/${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}

      - name: Create metadata
        id: createMetadata
        run: touch ${{ env.WORKING_DIR }}/meta-data

      - name: Render os-template w/ machineShop
        id: renderOsTemplate
        run: |
          machineShop render \
          --source local \
          --template packer/template/${{ inputs.os-version }}-${{ inputs.cloud }}.pkr.tpl.hcl \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --brackets square \
          --values "packerConfigMountPath=., ansiblePlayMountPath=., ansibleOsProvioning=${{ inputs.ansible-provisioning }}, osVersion=${{ inputs.os-version }}" \
          --destination ${{ env.WORKING_DIR }}//${{ inputs.os-version }}.pkr.hcl \
          --output file

      - name: Render Kickstart w/ machineShop
        id: renderKickstart
        run: |
          machineShop render \
          --source local \
          --template packer/kickstart/ubuntu-${{ inputs.cloud }}.yaml \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --output file \
          --destination ${{ env.WORKING_DIR }}/user-data

      - name: Render Playbook w/ machineShop
        id: renderBase-os
        run: |
          machineShop render \
          --source local \
          --template packer/ansible/play.yaml \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --output file \
          --brackets square \
          --destination ${{ env.WORKING_DIR }}/base-os.yaml

      - name: Render ansible requirements w/ machineShop requirements
        id: renderRequirements
        run: |
          machineShop render \
          --source local \
          --template packer/ansible/requirements.yaml \
          --defaults packer/environments/${{ inputs.lab }}-${{ inputs.cloud }}.yaml \
          --output file \
          --brackets square \
          --destination ${{ env.WORKING_DIR }}/requirements.yaml

      - name: Render Readme template w/ machineShop
        id: renderReadMeTemplate
        run: |
          machineShop render \
          --source local \
          --template packer/README.md.tpl \
          --output file \
          --brackets square \
          --values "packerVersion=${{ inputs.packer-version }}, osVersion=${{ inputs.os-version }}, lab=${{ inputs.lab }}, cloud=${{ inputs.cloud }}" \
          --destination ${{ env.WORKING_DIR }}/README.md

      - name: Create Pull Request for packer config
        id: pr
        uses: peter-evans/create-pull-request@v6.0.2
        with:
          commit-message: '[CI][PACKER] - Created template config for vm ${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}'
          title: Created Packer CONFIG  ${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}
          branch: ${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}
          # author: ${{ github.actor }}
          delete-branch: true
          labels: |
            packer
            ${{ inputs.os-version }}-${{ inputs.lab }}-${{ inputs.cloud }}
