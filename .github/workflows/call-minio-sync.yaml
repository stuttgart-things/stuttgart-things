---
name: Call Minio Sync
on:
  workflow_call:
    inputs:
      endpoint:
        required: true
        type: string
      folder:
        required: true
        type: string
      image:
        required: false
        type: string
        default: eu.gcr.io/stuttgart-things/sthings-mc-rclone:2024-05-14
      environment:
        required: true
        type: string
      bucket:
        required: true
        type: string
      s3_alias:
        required: true
        type: string
      runs-on:
        description: RUNNER NAME
        required: true
        type: string

jobs:
  Upload-Content-To-S3:
    name: Upload content to s3
    runs-on: ${{ inputs.runs-on }}
    container:
      image: ${{ inputs.image }}
    environment: ${{ inputs.environment }}
    env:
      S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
      S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
    continue-on-error: false
    steps:
      - uses: actions/download-artifact@v4.1.7
        with:
          name: ${{ inputs.folder }}
          path: ${{ inputs.folder }}
          
      - name: Checkout code
        run: |
          ls -lta

      - name: Upload to s3 Bucket
        run: |
          export AWS_ACCESS_KEY_ID=$S3_ACCESS_KEY_ID
          export AWS_SECRET_ACCESS_KEY=$S3_SECRET_ACCESS_KEY

          mkdir -p ${HOME}/.config/rclone/
          touch ${HOME}/.config/rclone/rclone.conf

          cat ${HOME}/.config/rclone/rclone.conf

          cat <<EOF > ${HOME}/.config/rclone/rclone.conf
          [${{ inputs.s3_alias }}]
          type = s3
          provider = Minio
          env_auth = true
          endpoint = ${{ inputs.endpoint }}
          acl = private
          region = us-central-1
          EOF

          cat ${HOME}/.config/rclone/rclone.conf
          
          # clean folder
          rclone delete ${{ inputs.s3_alias }}:${{ inputs.bucket }}/${{ inputs.folder }}

          # copy content to s3
          rclone -P copy ${{ inputs.folder }} ${{ inputs.s3_alias }}:${{ inputs.bucket }}/${{ inputs.folder }}

          rclone ls ${{ inputs.s3_alias }}:${{ inputs.bucket }}/${{ inputs.folder }}
