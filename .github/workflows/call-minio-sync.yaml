---
name: Call Minio Sync
on:
  workflow_call:
    inputs:
      endpoint:
        required: true
        type: string
      folder:
        required: true
        type: string
jobs:
  Upload-Content-To-S3:
    name: Upload content to s3
    runs-on: ghr-stuttgart-things-labda-test
    container:
      image: eu.gcr.io/stuttgart-things/sthings-mc-rclone:2024-05-14
    environment: labul-vsphere
    env:
      S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
      S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
    continue-on-error: false
    steps:
      - uses: actions/download-artifact@v4.1.7
        with:
          name: ${{ inputs.folder }}
          path: ${{ inputs.folder }}
          
      - name: Checkout code
        run: |
          ls -lta

      - name: Upload to s3 Bucket
        run: |
          export AWS_ACCESS_KEY_ID=$S3_ACCESS_KEY_ID
          export AWS_SECRET_ACCESS_KEY=$S3_SECRET_ACCESS_KEY

          mkdir -p ${HOME}/.config/rclone/
          touch ${HOME}/.config/rclone/rclone.conf

          cat ${HOME}/.config/rclone/rclone.conf

          cat <<EOF > ${HOME}/.config/rclone/rclone.conf
          [labul-app1]
          type = s3
          provider = Minio
          env_auth = true
          endpoint = ${{ inputs.endpoint }}
          acl = private
          region = us-central-1
          EOF

          cat ${HOME}/.config/rclone/rclone.conf
          
          # clean folder
          #rclone delete labul-app1:hugo/${{ inputs.folder }}

          # copy content to s3
          rclone -P copy ${{ inputs.folder }} labul-app1:hugo/${{ inputs.folder }}

          rclone ls labul-app1:hugo/${{ inputs.folder }}