name: Rollout GitHub Runner
on:
  pull_request:
    types:
      - opened
      - reopened

jobs:
  Get-Packer-Config:
    if: contains(github.event.pull_request.labels.*.name, 'test-vm')
    outputs:
      folder: ${{ steps.set.outputs.FOLDER }}
      template-name: ${{ steps.set.outputs.TEMPLATE_NAME }}
      branch: ${{ steps.set.outputs.BRANCH }}   
      operation: ${{ steps.set.outputs.OPERATION }}   
      environment: ${{ steps.set.outputs.ENVIRONMENT }}
      runs-on: ${{ steps.set.outputs.RUNS_ON }}
      working-image: ${{ steps.set.outputs.WORKING_IMAGE }}
    container:
      image: eu.gcr.io/stuttgart-things/machineshop:v1.7.2
    permissions:
      contents: read
      pull-requests: read
    runs-on: ghr-stuttgart-things-sthings-cicd
    steps:          
      - name: Get VM-Template name
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: successful
          
      - name: Get Test vm -path
        uses: peter-evans/find-comment@v3
        id: test
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: test

      - name: Show values for terraform execution
        id: show
        run: |
          echo "FOLDER=$(echo ${{ steps.test.outputs.comment-body }} | sed 's/.*\://' | xargs)/"
          echo "TEMPLATE_NAME=$(echo ${{ steps.fc.outputs.comment-body }} | sed 's/.*\://' | xargs)"
          echo "BRANCH=${{ github.event.pull_request.head.ref }}"
          echo "OPERATION=apply"
          echo "WORKING_IMAGE=eu.gcr.io/stuttgart-things/sthings-terraform:1.8.1-2"
          echo "RUNS_ON=ghr-stuttgart-things-sthings-cicd"
          LAB=$(echo ${{ github.event.pull_request.head.ref }} | cut -d'-' -f2)
          CLOUD=$(echo ${{ github.event.pull_request.head.ref }} | cut -d'-' -f3)
          echo "ENVIRONMENT=$(echo ${LAB}-${CLOUD})"

      - name: Set values for terraform execution
        id: set
        run: |
          echo "FOLDER=$(echo ${{ steps.test.outputs.comment-body }} | sed 's/.*\://')/ | xargs" >> "$GITHUB_OUTPUT"
          echo "TEMPLATE_NAME=$(echo ${{ steps.fc.outputs.comment-body }} | sed 's/.*\://' | xargs)" >> "$GITHUB_OUTPUT"
          echo "BRANCH=${{ github.event.pull_request.head.ref }}" >> "$GITHUB_OUTPUT"
          echo "OPERATION=apply" >> "$GITHUB_OUTPUT"
          echo "WORKING_IMAGE=eu.gcr.io/stuttgart-things/sthings-terraform:1.8.1-2" >> "$GITHUB_OUTPUT"
          echo "RUNS_ON=ghr-stuttgart-things-sthings-cicd" >> "$GITHUB_OUTPUT"
          LAB=$(echo ${{ github.event.pull_request.head.ref }} | cut -d'-' -f2)
          echo "ENVIRONMENT=$(echo ${LAB})" >> "$GITHUB_OUTPUT"

#  execute-terraform:
#    name: Execute Terraform
#    uses: stuttgart-things/stuttgart-things/.github/workflows/execute-terraform.yaml@main
#    needs: Get-Packer-Config
#    with:
#      folder: packer/builds/ubuntu23-labul-vsphere-base-os/test-vm #${{ needs.Get-Packer-Config.outputs.folder }}
#      branch: ${{ needs.Get-Packer-Config.outputs.branch }}
#      values: tbd
#      operation: ${{ needs.Get-Packer-Config.outputs.operation }}
#      working-image: ${{ needs.Get-Packer-Config.outputs.working-image }}
#      environment-name: labul-vsphere #${{ needs.Get-Packer-Config.outputs.environment }}
#      runs-on: ${{ needs.Get-Packer-Config.outputs.runs-on }}
#    secrets: inherit
