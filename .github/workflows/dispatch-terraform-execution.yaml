---
name: Dispatch Terraform Execution
on:
  workflow_dispatch:
    inputs:
      operation:
        type: choice
        description: TERRAFORM OPERATION
        options:
          - apply
          - destroy
      folder:
        description: FOLDER NAME
        type: string
        default: terraform/builds/
      branch-name:
        type: string
        description: BRANCH NAME
        default: main
      environment-name:
        type: choice
        description: ENVIRONMENT NAME
        options:
          - labul-vsphere
          - labda-vsphere
          - labul-proxmox
      working-image:
        description: WORKING IMAGE
        type: string
        default: eu.gcr.io/stuttgart-things/sthings-terraform:1.9.4-2
      runner:
        description: RUNNER NAME
        type: string
        default: ghr-stuttgart-things-labul-automation
jobs:
  Execute-Terraform:
    name: Execute Terraform
    uses: stuttgart-things/stuttgart-things/.github/workflows/call-terraform-execution.yaml@main
    with:
      folder: ${{ inputs.folder }}
      branch: ${{ inputs.branch-name }}
      operation: ${{ inputs.operation }}
      working-image: ${{ inputs.working-image}}
      environment-name: ${{ inputs.environment-name }}
      runs-on: ${{ inputs.runner }}
    secrets: inherit

  Send-Homerun-Notification:
    if: ${{ always() }}
    name: Send-Homerun-Notification
    uses: stuttgart-things/stuttgart-things/.github/workflows/call-homerun-notification.yaml@main
    needs:
      -  Execute-Terraform
    with:
      notification-tags: "terraform, github-actions"
      notification-info: ${{ needs.Execute-Terraform.outputs.tf-output }}
      runs-on: ${{ inputs.runner }}
      environment-name: ${{ inputs.environment-name }}
      machineshop-image: ghcr.io/stuttgart-things/machineshop/machineshop-9c3178088556daa12a17db5edcc6b5b7@sha256:a460d6349913bbe0902a18eee32aa1aca9d575633da9ab1ab
      continue-on-error: true
    secrets: inherit

    # run: |
    #   TITLE_PREFIX="Terraform execution ${{ inputs.operation }} for ${{ inputs.folder }} on github actions"
    #   SYSTEM="github"
    #   TAGS="terraform,github-actions"
    #   WORKFLOW_RESULT="succeded"
    #   WORKFLOW_SEVERITY="SUCCESS"
    #   BODY="REPOSITORY: ${GITHUB_REPOSITORY} WORKFLOW: ${GITHUB_WORKFLOW} ARTIFACT: ${{ inputs.folder }}@${{ inputs.branch-name }} RUNNER_NAME: ${RUNNER_NAME} WORKFLOW-IMAGE: ${{ inputs.kaniko-image }} ENV: ${{ inputs.environment-name }}"

    #   if [ "${{ needs.Execute-Terraform.result }}" != "success" ]; then
    #     WORKFLOW_RESULT="failed"
    #     WORKFLOW_SEVERITY="ERROR"
    #   fi

    #   TITLE="${TITLE_PREFIX} ${WORKFLOW_RESULT}"

    #   machineshop push \
    #   --destination https://homerun.homerun-dev.sthings-vsphere.labul.sva.de/generic \
    #   --target homerun \
    #   --title "${TITLE}" \
    #   --system "${SYSTEM}" \
    #   --info "${BODY}" \
    #   --tags "${TAGS}" \
    #   --author "${GITHUB_ACTOR}" \
    #   --severity "${WORKFLOW_SEVERITY}"